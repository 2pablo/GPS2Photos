<?php
/**
 * Azure Map function for GPS 2 Photos.
 *
 * @package    GPS 2 Photos Add-on
 * @subpackage Azure Map
 * @since      1.0.0
 */

// Security: Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Get the content for the modal window.
 *
 * @return string The HTML for the modal content.
 */
function gps2photos_get_map_for_modal() {
	$options      = gps2photos_convert_to_int( get_option( 'plugin_gps2photos_options' ) );
	$html_output  = '
<div id="gps2photos-modal" class="gps2photos-modal">
	<div class="gps2photos-modal-content" style="max-width: ' . esc_attr( $options['map_width'] ) . '; max-height: ' . esc_attr( $options['map_height'] ) . ';">		
		<div class="gps2photos-modal-header">
			<h2>' . esc_html__( 'Add/Amend GPS Coordinates', 'gps-2-photos' ) . '
				<span class="gps2photos-tooltip-container">
					<img class="gps2photos-tooltip-trigger" src="' . esc_attr( GPS_2_PHOTOS_DIR_URL . '/img/information.png' ) . '" alt="Info">
					<span class="gps2photos-tooltip-text">'
						. esc_html__(
							'For manual entry for Latitude please enter a value between -90 and 90. For Longitude please enter a value between -180 and 180. Both Latitude and Longitude must be provided. If both fields will be left empty this will erase coordinates.',
							'gps-2-photos'
						) . '
					</span>
				</span>
			</h2>
			<span class="gps2photos-modal-close">&times;</span>
		</div>
		<div id="gps2photos-map-container" class="gps2photos-map-container"></div>
		<div id="gps2photos-modal-inputs">
			<p>
                <label for="gps2photos-modal-lat-input">' . esc_html__( 'Latitude', 'gps-2-photos' ) . '</label><br/><input type="text" id="gps2photos-modal-lat-input" value="" style="width: 100%;" />
                <label for="gps2photos-modal-lon-input">' . esc_html__( 'Longitude', 'gps-2-photos' ) . '</label><br/><input type="text" id="gps2photos-modal-lon-input" value="" style="width: 100%;" /></p>';
	$checked      = isset( $options['always_override_gps'] ) && $options['always_override_gps'] === 1 ? 'checked' : '';
	$html_output .= '
			<p><input type="checkbox" id="gps2photos-override-checkbox" ' . $checked . '>&ensp;<label for="gps2photos-override-checkbox">' . esc_html__( 'Always override existing GPS coordinates without asking', 'gps-2-photos' ) . '</label></p>';
	$restore_btn  = esc_html__( 'Restore Original Coordinates', 'gps-2-photos' );
	$html_output .= '
			<div class="gps2photos-save-container">
				<button type="button" class="button button-primary gps2photos-save-coords-btn" data-image-id="" data-original-lat="" data-original-lon="" data-file-path="">' . esc_html__( 'Save Coordinates', 'gps-2-photos' ) . '</button>
				<div id="gps2photos-modal-message" class="gps2photos-modal-message" style="display: none;"></div>
			</div>
			<button type="button" class="button gps2photos-restore-coords-btn" data-image-id="" data-file-path="" style="display:none;">' . $restore_btn . '</button>
		</div>
	</div>
</div>';

	$inline_css = '
		.gps2photos-modal-header { display: flex; justify-content: space-between; align-items: flex-start; }
		.gps2photos-modal-header h2 { margin-top: 0; }
	';
	wp_add_inline_style( 'gps2photos-modal-css', $inline_css );

	$map_output = '
// GPS 2 PHOTOS Azure Map
// Store map and marker instances globally to be accessible.
window.gps2photos_maps = window.gps2photos_maps || {};
window.gps2photos_maps.marker = window.gps2photos_maps.marker || {};

window.gps2photos_init_map = function(apiKey, position) {
    // Prevent re-initialization.
    if (window.gps2photos_maps.map) {
        return;
    }

    var latInput = document.getElementById("gps2photos-modal-lat-input");
    var lonInput = document.getElementById("gps2photos-modal-lon-input");

	var hasInitialCoords;

    if (!position) {
        var initialLat = parseFloat(latInput.value) || 30;
        var initialLon = parseFloat(lonInput.value) || 0;
		var hasInitialCoords = !!(latInput.value && lonInput.value);
    } else {
        var initialLat = position[0];
        var initialLon = position[1];
		var hasInitialCoords = !!(position[0] && position[1]);
    }

    var map = new atlas.Map("gps2photos-map-container", {
        renderWorldCopies: false,
        authOptions: {
            authType: "subscriptionKey",
            subscriptionKey: apiKey
        },
        center: [initialLon, initialLat],
        zoom: hasInitialCoords ? ' . (int) $options['zoom'] . ' : 1,
        style: "' . esc_js( $options['map'] ) . '",
        showLogo: ' . ( $options['logo'] ? 'true' : 'false' ) . ',
        showFeedbackLink: false,
        view: "Auto"
    });';
	// About the "view" parameter: By default, the View parameter is set to Unified, even if you haven't defined it in the request. Determine the location of your users. Then, set the View parameter correctly for that location. Alternatively, you can set 'View=Auto', which returns the map data based on the IP address of the request. The View parameter in Azure Maps must be used in compliance with applicable laws, including those laws about mapping of the country/region where maps, images, and other data and third-party content that you're authorized to access via Azure Maps is made available.
	// https://learn.microsoft.com/en-us/azure/azure-maps/supported-languages#azure-maps-supported-views.

	$map_output .= '

    window.gps2photos_maps.map = map;
    window.gps2photos_maps.zoom = ' . (int) $options['zoom'] . ';

    map.events.add("ready", function () {
        var style = "auto"; // "auto", "light", "dark"
        if (' . ( $options['dashboard'] ? 'true' : 'false' ) . ') {
            map.controls.add([
                    new atlas.control.StyleControl({
                        style: style,
                        mapStyles: ["road", "satellite", "satellite_road_labels", "grayscale_light", "grayscale_dark", "night", "road_shaded_relief"] // "all" (shows some blank styles)
                    }),
                    new atlas.control.ZoomControl({style: style}),
                    new atlas.control.CompassControl({style: style}),
                    new atlas.control.PitchControl({style: style}),' . ( $options['scalebar'] ? '
                    new atlas.control.ScaleControl({
                        maxWidth: 100,
                        units: "metric" // or "imperial", "nautical"
                    }),' : '' ) . ( $options['locate_me_button'] ? '
                    new atlas.control.GeolocationControl({
                        style: style,
                        showUserLocation: true,
                    })' : '' ) . '
                ], {
                    position: "top-right" // Options: "top-left", "top-right", "bottom-left", "bottom-right", "non-fixed"
            });
        }
        map.controls.add([
                    new atlas.control.FullscreenControl({style: style})
                ], {
                    position: "top-left" // Options: "top-left", "top-right", "bottom-left", "bottom-right", "non-fixed"
            });
        var marker;

        function createMarker(position) {
            if (!marker) {
                // Create a custom SVG icon based on plugin settings.
                var pinColor = "' . esc_js( $options['pin_color'] ) . '";
                var secondaryColor = "' . esc_js( $options['pin_secondary_color'] ) . '";
                var iconType = "' . esc_js( $options['pin_icon_type'] ) . '";

                var svgIcon = atlas.getImageTemplate(iconType)
                    .replace(/{color}/g, pinColor)
                    .replace(/{secondaryColor}/g, secondaryColor);

				var h = 0; // horizontal pixel offset value to center not symmetric icons
				if (iconType === "flag") {
					// flag icon width is 23.5px /2 - 1px (half of flag post width)
					var h = 11; // pixel offset value to center the icon horizontally
				} else if (iconType === "flag-triangle") {
					// flag-triangle icon width is 27px
					var h = 12;
				}

                marker = new atlas.HtmlMarker({
                    position: position,
                    draggable: true,
                    htmlContent: svgIcon,
                    visible: hasInitialCoords,
					pixelOffset: [h, 0] // corrects horizontal position
                });
                map.markers.add(marker);
                window.gps2photos_maps.marker = marker;

                // Update inputs when dragging ends.
                map.events.add("dragend", marker, function () {
                    var pos = marker.getOptions().position;
                    latInput.value = pos[1].toFixed(7);
                    lonInput.value = pos[0].toFixed(7);
                });
                return marker;
            }
        }

        function addMarker(position) {
            if (marker) {
                marker.setOptions({ 
                    position: position,
                    visible: true
                });
            } else {
                createMarker(position);
            }
            latInput.value = position[1].toFixed(7);
            lonInput.value = position[0].toFixed(7);
        }

        // If coordinates exist, add the marker right away.
        if (hasInitialCoords) {
            addMarker([initialLon, initialLat]);
        } else {
            createMarker([0, 30]); // Default position if no initial coordinates.
        }

        // Add a marker on map click if one doesn\'t exist.
        map.events.add("click", function (e) {
            addMarker(e.position);
        });

        // Function to update marker from input fields.
		// Waits until the user stops typing (e.g., ~500 ms of no input),
		// unless the user pastes a complete coordinate string.
		function updateMarkerFromInputs() {
			var lat = parseFloat(latInput.value);
			var lon = parseFloat(lonInput.value);
			
			// Validate that both are numbers and within valid ranges.
			if (!isNaN(lat) && !isNaN(lon) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180) {
				var newPosition = [lon, lat];
				addMarker(newPosition);
				map.setCamera({
					center: newPosition,
					duration: 2000,
					type: "fly"
				});
			}
		}

        var updateTimer = null; //The id of the timer.
		var isPasting = false;

		function handleInput(event) {
			// If user pastes text (usually fast, not typed), allow immediate update
			var wasPasted = event.inputType === "insertFromPaste" || isPasting;
			
			if (wasPasted) {
				console.log("was pasted");
				// Run immediately on paste
				isPasting = false;
				updateMarkerFromInputs();
			} else {
				console.log(updateTimer);
				clearTimeout(updateTimer);
				// Wait until user stops typing (1000ms)
				updateTimer = setTimeout(updateMarkerFromInputs, 1000);
			}
		}

		//Track paste events
		latInput.addEventListener("paste", function() {
			isPasting = true;
		});
		lonInput.addEventListener("paste", function() {
			isPasting = true;
		});

        // Add event listeners to the input fields to update the marker.
        latInput.addEventListener("input", handleInput);
        lonInput.addEventListener("input", handleInput);
    });
}';
	wp_add_inline_script( 'gps2photos-map-js', $map_output );
	return $html_output;
}
